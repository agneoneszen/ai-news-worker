# 🚂 Railway 後端部署 - 立即開始

## ✅ 前端狀態確認

您的網站已經成功部署並可以訪問！顯示 "目前沒有新聞資料" 是正常的，因為後端還沒有執行任務來產生資料。

現在我們需要部署後端到 Railway，讓它開始抓取和分析新聞。

---

## 🚀 步驟 1: 建立 Railway 專案

### 1.1 登入 Railway

1. 前往 https://railway.app/
2. 點擊 **"Start a New Project"** 或 **"Login"**
3. 選擇 **"Deploy from GitHub repo"**
4. 授權 Railway 存取您的 GitHub 帳號
5. 選擇 `agneoneszen/ai-news-worker` repository
6. Railway 會自動開始部署

### 1.2 等待初始部署

- Railway 會自動偵測 `backend/Dockerfile`
- 第一次部署可能需要 2-3 分鐘
- 可以在 Deployments 標籤查看進度

---

## ⚙️ 步驟 2: 設定 Root Directory

1. 在 Railway Dashboard，點擊您的服務（通常會自動命名為 `ai-news-worker`）
2. 點擊 **Settings** 標籤
3. 找到 **Root Directory** 欄位
4. 輸入：`backend`
5. 點擊 **Save**（如果有的話，或 Railway 可能已自動偵測）

---

## 🔐 步驟 3: 設定環境變數

### 3.1 設定 OPENAI_API_KEY

1. 在服務頁面，點擊 **Variables** 標籤
2. 點擊 **New Variable** 或 **+ New**
3. 填寫：
   - **Key**: `OPENAI_API_KEY`
   - **Value**: 您的 OpenAI API Key
     - 如果還沒有，前往 https://platform.openai.com/api-keys 建立
4. 點擊 **Add** 或 **Save**

### 3.2 確認變數已設定

在 Variables 列表應該會看到：
```
OPENAI_API_KEY = sk-...
```

---

## 🔑 步驟 4: 上傳服務帳號金鑰

### 4.1 取得服務帳號金鑰內容

在終端機執行以下命令查看內容：

```bash
cat backend/serviceAccountKey.json
```

**重要**：複製完整的 JSON 內容（從 `{` 開始到 `}` 結束）

### 4.2 在 Railway 設定 Secret

1. 在服務頁面，點擊 **Settings** 標籤
2. 向下滾動找到 **Secrets** 區塊
3. 點擊 **New Secret** 或 **+ New Secret**
4. 填寫：
   - **Name**: `SERVICE_ACCOUNT_KEY`
   - **Value**: 貼上剛才複製的完整 JSON 內容
     - 必須是完整的 JSON，例如：
     ```json
     {
       "type": "service_account",
       "project_id": "your-project",
       "private_key_id": "...",
       "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
       ...
     }
     ```
5. 點擊 **Add Secret** 或 **Save**

### 4.3 確認 Secret 已設定

在 Secrets 列表應該會看到：
```
SERVICE_ACCOUNT_KEY = [Hidden]
```

---

## ✅ 步驟 5: 確認部署狀態

### 5.1 查看部署日誌

1. 在服務頁面，點擊 **Deployments** 標籤
2. 找到最新的部署
3. 點擊部署項目查看詳細資訊
4. 點擊 **Logs** 標籤查看日誌

### 5.2 預期看到的日誌

部署成功後，應該會看到：

```
⏰ AI News Worker 排程器已啟動
============================================================
📅 下次執行時間: 2025-12-27 09:00:00
🔄 檢查間隔: 每 60 秒
============================================================
```

### 5.3 如果看到錯誤

常見錯誤及解決方法：

**錯誤 1: "找不到 serviceAccountKey.json"**
- 確認 `SERVICE_ACCOUNT_KEY` Secret 已正確設定
- 確認 JSON 格式完整且正確

**錯誤 2: "OPENAI_API_KEY 未設定"**
- 確認環境變數 `OPENAI_API_KEY` 已設定
- 確認值正確（以 `sk-` 開頭）

**錯誤 3: "Firestore 連線失敗"**
- 確認 `SERVICE_ACCOUNT_KEY` Secret 內容正確
- 確認服務帳號有 Firestore 寫入權限

---

## 🧪 步驟 6: 測試執行（可選）

如果想立即測試後端是否正常：

### 方法 1: 等待排程執行

- 排程器會在每天 09:00 UTC 自動執行
- 可以等待到執行時間

### 方法 2: 修改排程為立即執行（測試用）

如果需要立即測試，可以暫時修改排程：

1. 在本地修改 `backend/scheduler_continuous.py`
2. 找到這行：
   ```python
   schedule.every().day.at("09:00").do(job_pipeline)
   ```
3. 暫時改為：
   ```python
   schedule.every().hour.do(job_pipeline)  # 每小時執行（測試用）
   # 或
   job_pipeline()  # 立即執行一次
   ```
4. 提交並推送到 GitHub：
   ```bash
   git add backend/scheduler_continuous.py
   git commit -m "Test: run scheduler immediately"
   git push
   ```
5. Railway 會自動重新部署
6. 測試完成後記得改回原設定

---

## 📊 步驟 7: 驗證資料產生

### 7.1 檢查 Firestore

1. 前往 Firebase Console: https://console.firebase.google.com/
2. 選擇您的專案
3. 點擊左側選單的 **Firestore Database**
4. 應該會看到 `daily_news` collection
5. 點擊查看是否有文件（以日期為 ID，例如：`2025-12-26`）

### 7.2 檢查前端

1. 重新整理您的網站
2. 應該會看到新聞卡片顯示
3. 如果還是空的，等待幾分鐘後再重新整理

---

## 🎯 快速檢查清單

- [ ] 已在 Railway 建立專案並連接 GitHub
- [ ] Root Directory 設為 `backend`（或已自動偵測）
- [ ] 已設定 `OPENAI_API_KEY` 環境變數
- [ ] 已上傳 `SERVICE_ACCOUNT_KEY` Secret
- [ ] 部署狀態為 "Deployed"
- [ ] Logs 顯示排程器已啟動
- [ ] Firestore 中有資料（等待執行後）
- [ ] 前端可以顯示新聞

---

## 🆘 需要幫助？

如果遇到問題，請告訴我：
1. Railway Logs 中顯示什麼錯誤？
2. 環境變數和 Secret 是否都已設定？
3. 部署狀態是什麼？

我可以協助您解決！

