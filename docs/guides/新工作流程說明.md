# 🔄 新工作流程說明

## 📊 工作流程變更

### 舊流程
1. 抓取前5篇新聞（不限時間）
2. 逐篇AI分析
3. 直接生成日報

### 新流程 ✨
1. **抓取過去24小時內的新聞**
2. **AI分類**：將文章分類（最多5個分類）
3. **統合同類文章**：將同類文章合併成一份文檔
4. **分類分析**：對每個分類的文檔進行深度分析
5. **生成日報**：根據分類分析結果生成決策日報

---

## 🔍 詳細流程說明

### 階段 1: 抓取過去24小時的新聞

**檔案**: `backend/scraper.py`

- 計算24小時前的時間點
- 遍歷所有RSS來源
- 解析每篇文章的發布時間
- **只保留過去24小時內的文章**
- 清理HTML標籤，保留更多內容（2000字）

**輸出**: 過去24小時內的新聞列表

---

### 階段 2: AI分類

**檔案**: `backend/scheduler.py` + `backend/ai_service.py`

- 對每篇文章進行AI分析
- 提取分類資訊（如：人工智慧、區塊鏈、硬體等）
- 將文章按分類分組
- **限制最多5個分類**（選擇文章數最多的5個）

**輸出**: 按分類分組的文章字典
```
{
  "人工智慧": [文章1, 文章2, ...],
  "區塊鏈": [文章3, 文章4, ...],
  ...
}
```

---

### 階段 3: 統合同類文章

**檔案**: `backend/ai_service.py` - `analyze_category_group()`

- 對每個分類：
  - 合併該分類下所有文章的內容
  - 保留文章標題列表
  - 準備統合文檔（最多8000字）

**輸出**: 每個分類的統合文檔

---

### 階段 4: 分類深度分析

**檔案**: `backend/ai_service.py` - `analyze_category_group()`

- 對每個分類的統合文檔進行AI分析
- 生成：
  - **統合摘要**（200-300字）
  - **關鍵重點**（4個要點）
  - **趨勢分析**（150-200字）

**輸出**: 分類分析結果
```json
{
  "category": "人工智慧",
  "summary": "統合摘要...",
  "key_points": ["重點1", "重點2", ...],
  "trend_analysis": "趨勢分析...",
  "article_count": 5,
  "article_titles": ["標題1", "標題2", ...]
}
```

---

### 階段 5: 生成決策日報

**檔案**: `backend/ai_service.py` - `generate_daily_briefing()`

- 根據所有分類的分析結果
- 生成Markdown格式的日報，包含：
  - **📊 市場情緒儀表板**
  - **🌊 核心趨勢分析**（3-5條故事線）
  - **🧭 決策指引**（技術建議、投資建議、風險提醒）
  - **📈 分類摘要**

**輸出**: 完整的Markdown日報

---

### 階段 6: 儲存到Firestore

**檔案**: `backend/scheduler.py`

- 寫入Firestore，包含：
  - `content`: 日報內容
  - `article_count`: 總文章數
  - `category_count`: 分類數量
  - `categories`: 分類列表
  - `category_summaries`: 分類摘要（新增）

**輸出**: Firestore文檔

---

## 📈 資料結構變更

### Firestore 文檔結構

```javascript
{
  date_str: "2025-12-26",
  content: "# 每日決策日報\n\n## 📊 市場情緒...",
  article_count: 15,  // 總文章數
  category_count: 4,   // 分類數量
  categories: ["人工智慧", "區塊鏈", "硬體", "商業"],
  category_summaries: [  // 新增
    {
      category: "人工智慧",
      article_count: 5,
      summary: "統合摘要...",
      key_points: ["重點1", "重點2", ...]
    },
    ...
  ],
  created_at: Timestamp,
  status: "published"
}
```

---

## ✅ 優勢

1. **時間精準**：只處理過去24小時的新聞，確保時效性
2. **分類清晰**：最多5個分類，避免資訊過載
3. **深度分析**：同類文章統合分析，提供更深入的洞察
4. **結構化資料**：分類摘要便於前端展示和篩選

---

## 🔧 技術變更

### 新增依賴
- `python-dateutil==2.9.0` - 用於時間解析

### 修改檔案
- `scraper.py` - 添加24小時時間過濾
- `scheduler.py` - 添加分類和統合邏輯
- `ai_service.py` - 新增 `analyze_category_group()` 函數
- `scheduler_continuous.py` - 同步更新工作流程

---

## 🚀 部署注意事項

1. **更新依賴**：Railway會自動安裝新的 `python-dateutil`
2. **重新部署**：推送變更後，Railway會自動重新部署
3. **測試**：首次執行時會立即測試，之後每天09:00 UTC執行

---

## 📝 日誌輸出範例

```
🚀 開始執行每日任務：2025-12-26
🕷️ [Scraper] 開始抓取外部 RSS（過去24小時）...
   📅 時間範圍: 2025-12-25 09:00:00 UTC 至現在
   - 正在讀取: The Verge...
   - 正在讀取: CoinDesk...
✅ [Scraper] 成功抓取 12 篇過去24小時內的真實新聞。
🧠 [2/5] 正在分類 12 篇新聞...
  - 已分類: AI breakthrough... -> 人工智慧
  - 已分類: Bitcoin surge... -> 區塊鏈
  ...
⚠️ 發現 6 個分類，將保留文章數最多的5個分類
✅ 保留分類: 人工智慧, 區塊鏈, 硬體, 商業, 資安
📚 [3/5] 正在統合並分析 5 個分類...
  - 分析分類「人工智慧」(4篇)...
    ✅ 完成
  - 分析分類「區塊鏈」(3篇)...
    ✅ 完成
  ...
📝 [4/5] 正在撰寫每日決策日報...
💾 [5/5] 正在寫入資料庫...
✅ 任務成功！真實日報已存入: daily_news/2025-12-26
   📊 統計: 12 篇文章，5 個分類
```

---

## 🎯 下一步

1. **提交變更**：推送到GitHub
2. **Railway自動部署**：等待部署完成
3. **查看日誌**：確認新流程正常運行
4. **驗證結果**：檢查Firestore中的新資料結構

