# 🔍 完整架構檢查與修復

## 📊 資料流分析

### 完整資料流

```
1. Railway (後端)
   ↓
2. 抓取 RSS 新聞 (scraper.py)
   ↓
3. AI 分析 (ai_service.py)
   ↓
4. 寫入 Firestore (scheduler.py)
   Collection: daily_news
   Document ID: 2025-12-26 (日期格式)
   ↓
5. Firebase Firestore
   ↓
6. Vercel (前端)
   ↓
7. 讀取 Firestore (useNewsData.js)
   ↓
8. 顯示在網頁 (App.jsx → NewsCard.jsx)
```

---

## ✅ 架構檢查結果

### 1. 後端 → Firestore ✅

**檔案**: `backend/scheduler.py`
- **Collection**: `daily_news` ✅
- **Document ID**: `{date_str}` (例如: `2025-12-26`) ✅
- **資料結構**:
  ```python
  {
    'date_str': '2025-12-26',
    'content': 'Markdown 日報內容',
    'article_count': 2,
    'category_count': 2,
    'categories': ['人工智慧', '其他'],
    'category_summaries': [...],
    'created_at': Timestamp,
    'status': 'published'
  }
  ```
- **狀態**: ✅ 正確

### 2. Firestore → 前端 ✅

**檔案**: `frontend/src/hooks/useNewsData.js`
- **Collection**: `daily_news` ✅
- **Query**: `limit(5)` ✅
- **資料讀取**: `onSnapshot` (即時監聽) ✅
- **狀態**: ✅ 正確

### 3. 前端顯示 ✅

**檔案**: `frontend/src/App.jsx` + `NewsCard.jsx`
- **讀取**: 使用 `useNewsData()` hook ✅
- **顯示**: 使用 `ReactMarkdown` 渲染 `content` ✅
- **狀態**: ✅ 正確

---

## 🔧 需要修復的問題

### 問題 1: Railway 使用已棄用的 Nixpacks

**從圖片看到**: Nixpacks 顯示為 "Deprecated"

**解決方案**: 使用 **Metal Build Environment** 或 **Dockerfile**

#### 方案 A: 使用 Metal Build Environment（推薦）

1. Settings > Build
2. **Builder**: 選擇 **Metal Build Environment**
3. **Root Directory**: 確認是 `backend`
4. Metal 會自動偵測 Python 並使用 `requirements.txt`

#### 方案 B: 使用 Dockerfile

1. Settings > Build
2. **Builder**: 選擇 **Dockerfile**
3. **Dockerfile Path**: `Dockerfile`
4. **Root Directory**: 確認是 `backend`

### 問題 2: Vercel 可能沒有設定 Root Directory

**檢查**:
1. 前往 Vercel Dashboard
2. Settings > General
3. **Root Directory**: 應該設為 `frontend`

**如果沒有設定**:
- Vercel 會從專案根目錄開始
- 可能找不到 `package.json`

### 問題 3: 前端環境變數可能未設定

**檢查**:
1. Vercel Dashboard > Settings > Environment Variables
2. 確認以下變數已設定：
   - `VITE_FIREBASE_API_KEY`
   - `VITE_FIREBASE_AUTH_DOMAIN`
   - `VITE_FIREBASE_PROJECT_ID`
   - `VITE_FIREBASE_STORAGE_BUCKET`
   - `VITE_FIREBASE_MESSAGING_SENDER_ID`
   - `VITE_FIREBASE_APP_ID`

---

## 🔍 詳細檢查清單

### Railway (後端)

#### Source 設定
- [x] Root Directory: `backend` ✅ (從圖片確認)

#### Build 設定
- [ ] Builder: **Metal Build Environment** 或 **Dockerfile** (不是 Nixpacks)
- [ ] 如果使用 Dockerfile: Dockerfile Path = `Dockerfile`

#### Variables 設定
- [ ] `OPENAI_API_KEY` 已設定
- [ ] `SERVICE_ACCOUNT_KEY` 已設定（完整 JSON）

#### 運行檢查
- [ ] 服務狀態: Active
- [ ] Logs 顯示排程器已啟動

### Vercel (前端)

#### General 設定
- [ ] Root Directory: `frontend` (如果專案結構需要)

#### Build 設定
- [ ] Build Command: `npm run build`
- [ ] Output Directory: `dist`
- [ ] Framework: `vite`

#### Environment Variables
- [ ] `VITE_FIREBASE_API_KEY`
- [ ] `VITE_FIREBASE_AUTH_DOMAIN`
- [ ] `VITE_FIREBASE_PROJECT_ID`
- [ ] `VITE_FIREBASE_STORAGE_BUCKET`
- [ ] `VITE_FIREBASE_MESSAGING_SENDER_ID`
- [ ] `VITE_FIREBASE_APP_ID`

### Firebase

#### Firestore 規則
- [ ] 允許讀取 `daily_news` collection
- [ ] 允許寫入（後端使用服務帳號，不受規則限制）

#### 資料驗證
- [ ] `daily_news` collection 有文件
- [ ] 文件包含 `content` 欄位
- [ ] 文件 ID 是日期格式（例如: `2025-12-26`）

---

## 🚀 立即修復步驟

### 步驟 1: 修復 Railway

1. **切換到 Metal Build Environment**:
   - Settings > Build
   - Builder: 選擇 **Metal Build Environment**
   - 儲存

2. **確認環境變數**:
   - Settings > Variables
   - 確認 `OPENAI_API_KEY` 和 `SERVICE_ACCOUNT_KEY` 已設定

3. **重新部署**:
   - Deployments > Redeploy

### 步驟 2: 修復 Vercel

1. **檢查 Root Directory**:
   - Settings > General
   - Root Directory: 設為 `frontend`（如果需要）

2. **檢查環境變數**:
   - Settings > Environment Variables
   - 確認所有 Firebase 變數已設定

3. **觸發部署**:
   ```bash
   git commit --allow-empty -m "Trigger Vercel deployment"
   git push
   ```

### 步驟 3: 驗證資料流

1. **檢查 Firestore**:
   - Firebase Console > Firestore Database
   - 確認 `daily_news` collection 有文件

2. **檢查前端**:
   - 打開 Vercel 網站
   - F12 > Console 查看是否有錯誤
   - 確認資料是否顯示

---

## 📋 完整串接檢查

### GitHub → Railway
- [ ] Railway 專案已連接 GitHub
- [ ] 監控分支: `main`
- [ ] Root Directory: `backend`

### GitHub → Vercel
- [ ] Vercel 專案已連接 GitHub
- [ ] 監控分支: `main`
- [ ] Root Directory: `frontend`（如果需要）

### Railway → Firebase
- [ ] 使用 `serviceAccountKey.json`（透過環境變數）
- [ ] 寫入 `daily_news` collection
- [ ] Document ID 格式: `YYYY-MM-DD`

### Firebase → Vercel
- [ ] 前端使用 Firebase Client SDK
- [ ] 讀取 `daily_news` collection
- [ ] 環境變數已設定

---

## 🎯 預期結果

### 成功標誌

1. **Railway**:
   - Build Logs 顯示成功建置
   - Logs 顯示排程器運行
   - 沒有錯誤訊息

2. **Firestore**:
   - `daily_news` collection 有文件
   - 文件包含完整資料

3. **Vercel**:
   - 網站可以訪問
   - 顯示最新日報
   - Console 沒有錯誤

---

## 🆘 如果還是有問題

請提供：
1. **Railway Build Logs**（完整內容）
2. **Vercel Build Logs**（如果有錯誤）
3. **Firebase Console 截圖**（Firestore 資料）
4. **前端 Console 錯誤**（F12 > Console）

我可以根據實際情況提供更具體的解決方案。

